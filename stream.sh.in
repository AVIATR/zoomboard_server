#!/bin/bash

#Make output folder & remove old files
#Cleanup or create WWW_DIR folder
if [[ -e "@WWW_DIR@" ]]; then
    read -p "@WWW_DIR@ exists, and will be removed. Are you sure (y/n)? " CHOICE
    echo    #move to a new line
    if [[ $CHOICE =~ ^[Yy]$ ]]; then
        rm -rf "@WWW_DIR@"
    else
        echo "Exiting without starting stream."
        exit 0
    fi
fi
mkdir -p @WWW_DIR@/html
cp html/index.html @WWW_DIR@/html/
mkdir @WWW_DIR@/hls/

#start streaming
#ffmpeg -f @MUXER@ -s @DEFAULT_FULL_RESOLUTION@ -r 30 -i @INPUT_DEVICE@ \
#    -f hls -hls_time 0.35 -hls_allow_cache 0 -hls_flags temp_file+delete_segments+independent_segments \
#        -hls_delete_threshold 1 -hls_list_size 20 -c:v libx264 -b:v 7000k -maxrate 10000k \
#            -crf 18 -flags +cgop+low_delay+qscale -r 3 -g 3 -refs 1 -strict normal \
#                -level 4.2 -profile:v high -preset ultrafast -tune zerolatency -pix_fmt yuv420p \
#                    -vf "[in]drawtext=text='time=%{localtime}':box=1:x=(w-tw)/2:y=2*lh, drawtext=text='frame=%{n}, ts=%{pts\:hms}':box=1:x=(w-tw)/2:y=(3*lh)" \
 #                       @WWW_DIR@/hls/stream_hr.m3u8

ffmpeg -f @MUXER@ -s @DEFAULT_FULL_RESOLUTION@ -r 30 -i @INPUT_DEVICE@ \
        -map '[out_hr]' -f hls -hls_time 0.35 -hls_allow_cache 0 -hls_flags temp_file+delete_segments+independent_segments \
            -hls_delete_threshold 1 -hls_list_size 12 -c:v libx264 -b:v 7000k -maxrate 10000k -crf 18 -flags +cgop+low_delay+qscale \
                -r 3 -g 3 -refs 1 -strict normal -level 4.2 -profile:v high -preset ultrafast -tune zerolatency -pix_fmt yuv420p \
                    @WWW_DIR@/hls/stream_hr.m3u8 \
        -map '[out_lr]' -f hls -hls_time 0.1 -hls_allow_cache 0 -hls_flags temp_file+delete_segments+independent_segments \
            -hls_delete_threshold 1 -hls_list_size 60 -c:v libx264 -s 384x216 -b:v 3000k -maxrate 5000k -crf 18 -flags +cgop+low_delay+qscale \
                -r 15 -g 15 -refs 1 -strict normal -level 4.2 -profile:v high -preset ultrafast -tune zerolatency -pix_fmt yuv420p \
                    @WWW_DIR@/hls/stream_lr.m3u8

